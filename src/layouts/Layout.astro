---
// src/layouts/Layout.astro
import Head from '../components/Head.astro';
import Nav from '../components/Nav.astro';
import Footer from '../components/Footer.astro';
import CookieBanner from '../components/CookieBanner.astro';
import '../styles/global.css';

const GTM_ID = import.meta.env.PUBLIC_GTM_ID;
const GA4_ID = import.meta.env.PUBLIC_GA4_ID; // usable inside GTM configuration

const analyticsScript = `
  const GTM_ID = ${JSON.stringify(GTM_ID)};
  const GA4_ID = ${JSON.stringify(GA4_ID)};
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('consent','default',{
    ad_storage:'denied',
    analytics_storage:'denied',
    ad_user_data:'denied',
    ad_personalization:'denied'
  });
  gtag('js', new Date());
  gtag('config', GA4_ID);
  (function (w, d, s, l, i) {
    w[l] = w[l] || [];
    w[l].push({ 'gtm.start': new Date().getTime(), event: 'gtm.js' });
    const f = d.getElementsByTagName(s)[0],
      j = d.createElement(s),
      dl = l != 'dataLayer' ? '&l=' + l : '';
    j.async = true;
    j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
    f.parentNode.insertBefore(j, f);
  })(window, document, 'script', 'dataLayer', GTM_ID);
`;

const {
  title,
  description,
  canonical = new URL(
    Astro.url.pathname.endsWith('/') ? Astro.url.pathname : Astro.url.pathname + '/',
    Astro.site
  ).toString(),
  image = new URL('/images/og-image.jpg', Astro.site).toString(),
  robots = 'index,follow',
  keywords,
  type = 'website',
  siteName = 'Páginas web a Medida',
  schema,
  footerSticky = true,
} = Astro.props;

const defaultSchema = {
  "@context": "https://schema.org",
  "@type": "ProfessionalService",
  "name": siteName,
  "url": canonical,
  "logo": new URL('/images/logo.webp', Astro.site).toString(),
  "description": description,
  "address": {
    "@type": "PostalAddress",
    "streetAddress": "Avenida Glasgow 156",
    "addressLocality": "Nuevo Baztán",
    "addressRegion": "Madrid",
    "postalCode": "28514",
    "addressCountry": "ES"
  },
  "telephone": "+34623962963",
  "openingHours": "Mo-Fr 09:30-18:00",
  "priceRange": "$$",
  "sameAs": [
    "https://linkedin.com/in/jordi-martinez-joyeux",
    "https://github.com/Dolp175"
  ]
};

let schemaData;

if (schema) {
  schemaData = Array.isArray(schema)
    ? [defaultSchema, ...schema]
    : [defaultSchema, schema];
} else {
  schemaData = defaultSchema;
}
---

<!DOCTYPE html>
<html lang="es">
<head>
  <Head
    {title}
    {description}
    canonical={canonical}
    image={image}
    robots={robots}
    {keywords}
    {type}
    siteName={siteName}
  />
  <script async src={`https://www.googletagmanager.com/gtag/js?id=${GA4_ID}`}></script>
  <script is:inline set:html={analyticsScript} />
</head>
<body class="bg-white text-gray-800 min-h-screen flex flex-col relative">
  <noscript>
    <iframe
      src={`https://www.googletagmanager.com/ns.html?id=${GTM_ID}`}
      height="0"
      width="0"
      style="display:none;visibility:hidden"
    ></iframe>
  </noscript>
  <Nav />
  <main class="flex-grow relative z-10">
    <slot />
  </main>
  <Footer sticky={footerSticky} />
  <CookieBanner />
  <script type="module" src="/src/scripts/analytics.ts"></script>

  <!-- Schema.org JSON-LD -->
  <script type="application/ld+json" set:html={JSON.stringify(schemaData)} />
</body>
</html>
