---
// src/layouts/Layout.astro
import Head from '../components/Head.astro';
import Nav from '../components/Nav.astro';
import Footer from '../components/Footer.astro';
import CookieBanner from '../components/CookieBanner.astro';
import '../styles/global.css';

const GTM_ID = import.meta.env.PUBLIC_GTM_ID; // p.ej. GTM-NCFC9T5F
const GA4_ID = import.meta.env.PUBLIC_GA4_ID; // p.ej. G-H7CDJRC7FE

const analyticsScript = `
  // --- DataLayer + Consent Mode (denegado por defecto) ---
  window.dataLayer = window.dataLayer || [];
  window.gtag = window.gtag || function(){ window.dataLayer.push(arguments); };
  window.gtag('consent','default',{
    ad_storage:'denied',
    analytics_storage:'denied',
    ad_user_data:'denied',
    ad_personalization:'denied',
    wait_for_update: 500
  });

  // --- Utilidades ---
  function unlockPreconnects(){
    document.querySelectorAll('link[data-rel="preconnect"][data-href]').forEach(function(l){
      l.rel = 'preconnect';
      l.href = l.getAttribute('data-href');
      l.removeAttribute('data-rel');
      l.removeAttribute('data-href');
    });
  }

  function loadScript(src, attrs){
    return new Promise(function(resolve){
      var s=document.createElement('script');
      s.src = src;
      s.async = true;
      if (attrs) Object.keys(attrs).forEach(k => s.setAttribute(k, attrs[k]));
      s.onload = resolve;
      document.head.appendChild(s);
    });
  }

  function applyConsent(value){
    if (typeof window.gtag === 'function'){
      window.gtag('consent','update',{
        ad_storage: value,
        analytics_storage: value,
        ad_user_data: value,
        ad_personalization: value
      });
    }
  }

  function enableVendorsOnce(){
    if (window.__vendorsLoaded) return;
    window.__vendorsLoaded = true;

    unlockPreconnects();

    ${GTM_ID ? `
    // Cargar GTM
    (function(w,d,s,l,i){
      w[l]=w[l]||[];
      w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
      var f=d.getElementsByTagName(s)[0], j=d.createElement(s), dl=l!='dataLayer'?'&l='+l:'';
      j.async=true; j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
      f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','${GTM_ID}');
    ` : ''}

    ${!GTM_ID && GA4_ID ? `
    // Cargar GA4 directo si no hay GTM
    loadScript('https://www.googletagmanager.com/gtag/js?id=${GA4_ID}').then(function(){
      window.gtag('js', new Date());
      window.gtag('config', '${GA4_ID}', { send_page_view: true });
    });
    ` : ''}
  }

  // --- 1) Escuchar CustomEvent del banner (si lo emite) ---
  window.addEventListener('pm_consent_changed', function(e){
    var value = e && (e.detail || e.consent) || 'denied';
    applyConsent(value);
    if (value === 'granted') enableVendorsOnce();
  });

  // --- 2) Interceptar dataLayer.push del banner (si usa dataLayer en vez de CustomEvent) ---
  (function tapDataLayerForConsent(){
    var dl = window.dataLayer;
    if (!dl) return;
    var originalPush = dl.push;
    dl.push = function(){
      for (var i=0;i<arguments.length;i++){
        var item = arguments[i];
        if (item && item.event === 'pm_consent_changed'){
          var v = item.consent || item.value || 'denied';
          applyConsent(v);
          if (v === 'granted') enableVendorsOnce();
        }
      }
      return originalPush.apply(dl, arguments);
    }
  })();

  // --- 3) Si ya había consentimiento guardado, cargar sin esperar al banner ---
  (function bootFromStoredConsent(){
    try{
      var stored = localStorage.getItem('pm_cookie_consent_v2');
      if (stored === 'granted'){
        applyConsent('granted');
        enableVendorsOnce();
      }
    }catch(e){}
  })();
`;

const {
  title,
  description,
  canonical = new URL(
    Astro.url.pathname.endsWith('/') ? Astro.url.pathname : Astro.url.pathname + '/',
    Astro.site
  ).toString(),
  image = new URL('/images/og-image.jpg', Astro.site).toString(),
  robots = 'index,follow',
  keywords,
  type = 'website',
  siteName = 'Páginas web a Medida',
  schema,
  footerSticky = true,
} = Astro.props;

const defaultSchema = {
  "@context": "https://schema.org",
  "@type": "ProfessionalService",
  "name": siteName,
  "url": canonical,
  "logo": new URL('/images/logo.webp', Astro.site).toString(),
  "description": description,
  "address": {
    "@type": "PostalAddress",
    "streetAddress": "Avenida Glasgow 156",
    "addressLocality": "Nuevo Baztán",
    "addressRegion": "Madrid",
    "postalCode": "28514",
    "addressCountry": "ES"
  },
  "telephone": "+34623962963",
  "openingHours": "Mo-Fr 09:30-18:00",
  "priceRange": "$$",
  "sameAs": [
    "https://linkedin.com/in/jordi-martinez-joyeux",
    "https://github.com/Dolp175"
  ]
};

const schemaData = schema
  ? (Array.isArray(schema) ? [defaultSchema, ...schema] : [defaultSchema, schema])
  : defaultSchema;
---
<!DOCTYPE html>
<html lang="es">
<head>
  <Head
    {title}
    {description}
    canonical={canonical}
    image={image}
    robots={robots}
    {keywords}
    {type}
    siteName={siteName}
  />

  <!-- Preconnect diferido: solo se activa tras consentimiento -->
  <link data-rel="preconnect" data-href="https://www.googletagmanager.com" crossorigin>
  <link rel="dns-prefetch" href="//www.googletagmanager.com">

  <!-- Script unificado (sin GA4 directo si hay GTM) -->
  <script is:inline set:html={analyticsScript} />
</head>
<body class="bg-white text-gray-800 min-h-screen flex flex-col relative">
  <!-- En sitios con exigencia estricta de consentimiento, es más seguro NO incluir el noscript de GTM -->
  <noscript>
    <div style="padding:1rem;text-align:center;background:#f6f5ff;color:#4338ca">
      Para respetar tu privacidad, no cargamos analítica sin tu consentimiento.
    </div>
  </noscript>

  <Nav />
  <main class="flex-grow relative z-10" id="main-content">
    <slot />
  </main>
  <Footer sticky={footerSticky} />
  <CookieBanner gtmId={GTM_ID} gaId={GA4_ID} />

  <!-- JSON-LD -->
  <script type="application/ld+json" set:html={JSON.stringify(schemaData)} />
</body>
</html>
